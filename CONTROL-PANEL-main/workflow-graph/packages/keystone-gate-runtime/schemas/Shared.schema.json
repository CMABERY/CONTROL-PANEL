{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://control-panel.local/schemas/keystone/Shared.schema.json",
  "title": "Keystone Gate Shared Definitions",
  "type": "object",
  "$defs": {
    "SpecVersion": { "type": "string", "const": "1.0.0" },
    "CanonVersion": { "type": "string", "const": "1" },

    "Hash256": { "type": "string", "pattern": "^[0-9a-f]{64}$" },
    "TraceId": { "type": "string", "pattern": "^(?!0{32})[0-9a-f]{32}$" },
    "SpanId": { "type": "string", "pattern": "^(?!0{16})[0-9a-f]{16}$" },

    "Token": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128,
      "pattern": "^[a-z0-9][a-z0-9_\\-:.]{0,127}$"
    },

    "Resource": {
      "type": "string",
      "minLength": 1,
      "maxLength": 256,
      "pattern": "^[a-z0-9][a-z0-9_\\-:./]{0,255}$"
    },

    "ContentType": {
      "type": "string",
      "minLength": 3,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9!#$&^_.+-]+/[A-Za-z0-9!#$&^_.+-]+$"
    },

    "IntSafe": {
      "type": "integer",
      "minimum": -9007199254740991,
      "maximum": 9007199254740991
    },

    "IntNonNegative": {
      "type": "integer",
      "minimum": 0,
      "maximum": 9007199254740991
    },

    "IntMillis": {
      "$ref": "#/$defs/IntNonNegative"
    },

    "StringSet": {
      "type": "object",
      "propertyNames": { "$ref": "#/$defs/Token" },
      "additionalProperties": { "type": "boolean", "const": true }
    },

    "Producer": {
      "type": "object",
      "additionalProperties": false,
      "required": ["layer", "component"],
      "properties": {
        "layer": { "$ref": "#/$defs/Token" },
        "component": { "$ref": "#/$defs/Token" }
      }
    },

    "Actor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["actor_kind", "actor_id"],
      "properties": {
        "actor_kind": { "$ref": "#/$defs/Token" },
        "actor_id": { "$ref": "#/$defs/Resource" }
      }
    },

    "Credential": {
      "type": "object",
      "additionalProperties": false,
      "required": ["credential_kind", "issuer", "presented_hash_sha256", "verified_at_ms", "expires_at_ms"],
      "properties": {
        "credential_kind": { "$ref": "#/$defs/Token" },
        "issuer": { "type": "string", "minLength": 1, "maxLength": 256 },
        "presented_hash_sha256": { "$ref": "#/$defs/Hash256" },
        "verified_at_ms": { "$ref": "#/$defs/IntNonNegative" },
        "expires_at_ms": { "$ref": "#/$defs/IntNonNegative" }
      }
    },

    "PolicyRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["policy_id", "policy_version", "policy_sha256"],
      "properties": {
        "policy_id": { "$ref": "#/$defs/Token" },
        "policy_version": { "$ref": "#/$defs/Token" },
        "policy_sha256": { "$ref": "#/$defs/Hash256" }
      }
    },

    "PolicyRequest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["action", "resource"],
      "properties": {
        "action": { "$ref": "#/$defs/Token" },
        "resource": { "$ref": "#/$defs/Resource" }
      }
    },

    "PolicyDecision": {
      "type": "object",
      "additionalProperties": false,
      "required": ["result", "reason_codes", "obligations"],
      "properties": {
        "result": { "type": "string", "enum": ["allow", "deny"] },
        "reason_codes": { "$ref": "#/$defs/StringSet" },
        "obligations": { "$ref": "#/$defs/StringSet" }
      }
    },

    "Decision": {
      "$ref": "#/$defs/PolicyDecision"
    },

    "BlobRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["content_type", "sha256", "size_bytes"],
      "properties": {
        "content_type": { "$ref": "#/$defs/ContentType" },
        "sha256": { "$ref": "#/$defs/Hash256" },
        "size_bytes": { "$ref": "#/$defs/IntNonNegative" }
      }
    },

    "Outcome": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status"],
      "properties": {
        "status": { "$ref": "#/$defs/Token" }
      }
    },

    "ModelRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["provider", "model"],
      "properties": {
        "provider": { "$ref": "#/$defs/Token" },
        "model": { "$ref": "#/$defs/Token" }
      }
    },

    "ToolRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["adapter_id", "tool_name"],
      "properties": {
        "adapter_id": { "$ref": "#/$defs/Token" },
        "tool_name": { "$ref": "#/$defs/Token" }
      }
    },

    "Usage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["input_tokens", "output_tokens", "total_tokens"],
      "properties": {
        "input_tokens": { "$ref": "#/$defs/IntNonNegative" },
        "output_tokens": { "$ref": "#/$defs/IntNonNegative" },
        "total_tokens": { "$ref": "#/$defs/IntNonNegative" }
      }
    }
  },
  "additionalProperties": false,
  "properties": {}
}
