
> keystone-gate-runtime@0.1.0 test
> node --test test/*.test.js

TAP version 13
# Subtest: IT-FV-HASH-001: FlowVersion canonicalization + hashing matches goldens
    # Subtest: e2e_allow_model_call_ok steps hash deterministically
    ok 1 - e2e_allow_model_call_ok steps hash deterministically
      ---
      duration_ms: 6.418464
      type: 'test'
      ...
    # Subtest: e2e_allow_tool_call_ok steps hash deterministically
    ok 2 - e2e_allow_tool_call_ok steps hash deterministically
      ---
      duration_ms: 1.18462
      type: 'test'
      ...
    1..2
ok 1 - IT-FV-HASH-001: FlowVersion canonicalization + hashing matches goldens
  ---
  duration_ms: 8.670602
  type: 'suite'
  ...
# Subtest: IT-CPO-ACCEPT-001: AuthContext accepted and persisted
    # Subtest: commit_action accepts auth_context when declared hash matches
    ok 1 - commit_action accepts auth_context when declared hash matches
      ---
      duration_ms: 0.90086
      type: 'test'
      ...
    1..1
ok 2 - IT-CPO-ACCEPT-001: AuthContext accepted and persisted
  ---
  duration_ms: 1.016988
  type: 'suite'
  ...
# Subtest: IT-CPO-ACCEPT-002: PolicyDecision accepted only with existing AuthContext
    # Subtest: policy_decision rejected when auth prereq missing
    ok 1 - policy_decision rejected when auth prereq missing
      ---
      duration_ms: 0.425788
      type: 'test'
      ...
    # Subtest: policy_decision accepted when auth prereq exists
    ok 2 - policy_decision accepted when auth prereq exists
      ---
      duration_ms: 0.397808
      type: 'test'
      ...
    1..2
ok 3 - IT-CPO-ACCEPT-002: PolicyDecision accepted only with existing AuthContext
  ---
  duration_ms: 1.059317
  type: 'suite'
  ...
# Subtest: IT-CPO-ACCEPT-003: ModelCall accepted only with allow policy and trace continuity
    # Subtest: model_call accepted end-to-end (auth -> pd allow -> model_call ok)
    ok 1 - model_call accepted end-to-end (auth -> pd allow -> model_call ok)
      ---
      duration_ms: 0.9991
      type: 'test'
      ...
    # Subtest: model_call rejected when declared hash mismatches computed hash
    ok 2 - model_call rejected when declared hash mismatches computed hash
      ---
      duration_ms: 0.798963
      type: 'test'
      ...
    # Subtest: model_call rejected when trace_id differs from prereqs
    ok 3 - model_call rejected when trace_id differs from prereqs
      ---
      duration_ms: 0.818025
      type: 'test'
      ...
    # Subtest: model_call rejected when policy_decision prereq missing
    ok 4 - model_call rejected when policy_decision prereq missing
      ---
      duration_ms: 0.554385
      type: 'test'
      ...
    1..4
ok 4 - IT-CPO-ACCEPT-003: ModelCall accepted only with allow policy and trace continuity
  ---
  duration_ms: 3.648105
  type: 'suite'
  ...
# Subtest: IT-ADAPTER-ACCEPT-001: ToolCall accepted only with allow policy and trace continuity
    # Subtest: tool_call accepted end-to-end (auth -> pd allow -> tool_call ok)
    ok 1 - tool_call accepted end-to-end (auth -> pd allow -> tool_call ok)
      ---
      duration_ms: 0.529302
      type: 'test'
      ...
    # Subtest: tool_call rejected when policy decision is deny
    ok 2 - tool_call rejected when policy decision is deny
      ---
      duration_ms: 0.584979
      type: 'test'
      ...
    1..2
ok 5 - IT-ADAPTER-ACCEPT-001: ToolCall accepted only with allow policy and trace continuity
  ---
  duration_ms: 1.231334
  type: 'suite'
  ...
# Subtest: IT-SCHEMA-REJECT-001: Schema rejects are terminal and non-persistent
    # Subtest: missing trace_id -> SCHEMA_REJECT and not stored
    ok 1 - missing trace_id -> SCHEMA_REJECT and not stored
      ---
      duration_ms: 0.310444
      type: 'test'
      ...
    # Subtest: extra unknown field -> SCHEMA_REJECT
    ok 2 - extra unknown field -> SCHEMA_REJECT
      ---
      duration_ms: 0.173403
      type: 'test'
      ...
    1..2
ok 6 - IT-SCHEMA-REJECT-001: Schema rejects are terminal and non-persistent
  ---
  duration_ms: 0.577661
  type: 'suite'
  ...
# Subtest: IT-RECORD-TYPE-001: Unknown record types are forbidden
    # Subtest: unknown record_type -> RECORD_TYPE_FORBIDDEN
    ok 1 - unknown record_type -> RECORD_TYPE_FORBIDDEN
      ---
      duration_ms: 0.118015
      type: 'test'
      ...
    1..1
ok 7 - IT-RECORD-TYPE-001: Unknown record types are forbidden
  ---
  duration_ms: 0.17325
  type: 'suite'
  ...
# Subtest: Phase 4 Cross-Layer Conformance (gate-enforced)
    # Subtest: suite metadata is version-locked
    ok 1 - suite metadata is version-locked
      ---
      duration_ms: 1.671433
      type: 'test'
      ...
    # Subtest: vector: same_envelope_auth_context_key_order
    ok 2 - vector: same_envelope_auth_context_key_order
      ---
      duration_ms: 2.782086
      type: 'test'
      ...
    # Subtest: vector: same_envelope_tool_call_key_order
    ok 3 - vector: same_envelope_tool_call_key_order
      ---
      duration_ms: 3.614143
      type: 'test'
      ...
    # Subtest: vector: same_envelope_model_call_key_order
    ok 4 - vector: same_envelope_model_call_key_order
      ---
      duration_ms: 2.365001
      type: 'test'
      ...
    # Subtest: vector: policy_decision_missing_auth_prereq
    ok 5 - vector: policy_decision_missing_auth_prereq
      ---
      duration_ms: 0.345037
      type: 'test'
      ...
    # Subtest: vector: declared_hash_drift_rejected
    ok 6 - vector: declared_hash_drift_rejected
      ---
      duration_ms: 0.789417
      type: 'test'
      ...
    # Subtest: vector: missing_prereq_policy_decision
    ok 7 - vector: missing_prereq_policy_decision
      ---
      duration_ms: 0.814209
      type: 'test'
      ...
    # Subtest: vector: trace_violation_trace_id_mismatch
    ok 8 - vector: trace_violation_trace_id_mismatch
      ---
      duration_ms: 0.759411
      type: 'test'
      ...
    # Subtest: vector: unauthorized_execution_policy_denied
    ok 9 - vector: unauthorized_execution_policy_denied
      ---
      duration_ms: 0.718411
      type: 'test'
      ...
    # Subtest: vector: schema_reject_extra_field
    ok 10 - vector: schema_reject_extra_field
      ---
      duration_ms: 0.482816
      type: 'test'
      ...
    # Subtest: vector: schema_reject_missing_trace_id
    ok 11 - vector: schema_reject_missing_trace_id
      ---
      duration_ms: 0.138394
      type: 'test'
      ...
    1..11
ok 8 - Phase 4 Cross-Layer Conformance (gate-enforced)
  ---
  duration_ms: 15.680739
  type: 'suite'
  ...
# Subtest: PHASE5: Replay plumbing (evidence-locked)
    # Subtest: Replay index resolves accepted chain and rejected-attempts by trace_id deterministically
    ok 1 - Replay index resolves accepted chain and rejected-attempts by trace_id deterministically
      ---
      duration_ms: 89.050893
      type: 'test'
      ...
    # Subtest: Forensic replay passes on the Phase 4 certification trace and emits a content-addressed replay result artifact
    ok 2 - Forensic replay passes on the Phase 4 certification trace and emits a content-addressed replay result artifact
      ---
      duration_ms: 2.032616
      type: 'test'
      ...
    # Subtest: Invariant replay passes on the same trace and emits a result artifact
    ok 3 - Invariant replay passes on the same trace and emits a result artifact
      ---
      duration_ms: 2.036849
      type: 'test'
      ...
    # Subtest: Constrained replay: allows model_call.response variance but fails when variance is not permitted
    ok 4 - Constrained replay: allows model_call.response variance but fails when variance is not permitted
      ---
      duration_ms: 5.736183
      type: 'test'
      ...
    1..4
ok 9 - PHASE5: Replay plumbing (evidence-locked)
  ---
  duration_ms: 100.039613
  type: 'suite'
  ...
1..9
# tests 29
# suites 9
# pass 29
# fail 0
# cancelled 0
# skipped 0
# todo 0
# duration_ms 1547.896372
